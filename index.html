<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>ë‹¬ìˆ˜ í‚¤ìš°ê¸°: íŒêµ ì§ì¥ì¸ ìƒì¡´ê¸°</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#0a0a1a;display:flex;justify-content:center;align-items:center;font-family:'Malgun Gothic','ë§‘ì€ ê³ ë”•',sans-serif}
canvas{display:block;image-rendering:auto;cursor:pointer}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
'use strict';

/* â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘  ë‹¬ìˆ˜ í‚¤ìš°ê¸°: íŒêµ ì§ì¥ì¸ ìƒì¡´ê¸°                                      â•‘
   â•‘  ë‹¨ì¼ HTML5 Canvas ëŸ¬ë‹ ì í”„ ê²Œì„                                    â•‘
   â•‘  ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì—†ì´ ìˆœìˆ˜ HTML/CSS/JavaScript                        â•‘
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ ìƒìˆ˜ â€” ë°¸ëŸ°ìŠ¤ ì¡°ì •ì€ ì—¬ê¸°ì„œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CFG = {
  W: 1280, H: 720,
  GROUND: 580,

  // ë¬¼ë¦¬
  GRAVITY: 0.72,
  JUMP: -15.2,
  JUMP_HOLD: -0.55,
  COYOTE: 100,        // ms
  JUMP_BUF: 100,      // ms

  // ì†ë„
  BASE_SPD: 5.5,
  MAX_SPD: 15,
  SPD_ACC: 0.003,

  // ì„±ì¥
  GROW_PER_CLEAR: 18,
  GROW_COMBO: 8,
  COMBO_TIMEOUT: 2500, // ms

  // ìŠ¤íŠ¸ë ˆìŠ¤
  STR_HIT: 22,
  STR_OVERTIME: 0.35,  // per second
  STR_COFFEE: -35,
  STR_CHECKPOINT: -15,
  STR_COMBO: -1.2,
  BURNOUT_DUR: 5000,   // ms

  // ì¥ì• ë¬¼ ìŠ¤í°
  OBS_MIN: 1300,
  OBS_MAX: 2600,

  // ì•„ì´í…œ
  ITEM_CHANCE: 0.18,

  // ì´ë²¤íŠ¸
  EVT_SCORE_INTERVAL: 280,
  EVT_CHOICE_TIME: 3000, // ms

  // ì•¼ê·¼
  OVERTIME_TIME: 0.75,  // í•˜ë£¨ ì¤‘ ì•¼ê·¼ ì‹œì‘ ë¹„ìœ¨
  OVERTIME_SPD: 1.25,
  OVERTIME_SCORE: 1.8,
  OVERTIME_SPAWN: 0.7,

  // ê±°ëŒ€ ë‹¬ìˆ˜
  GIANT_DUR: 10000,
  GIANT_SCORE: 2,

  // íŒŒí‹°í´
  MAX_PARTICLES: 250,

  // ë‚ ì”¨
  WEATHER_INTERVAL: 50000,
  WEATHER_DUR: 22000,

  // í•˜ë£¨ ì‹œê°„ (ê²Œì„ ë‚´ í•˜ë£¨ = 120ì´ˆ)
  DAY_LENGTH: 120,

  // ì„±ì¥ ë‹¨ê³„
  STAGES: [
    { name:'ì‹ ì…',     scale:0.70, thr:0 },
    { name:'ì ì‘ ì¤‘',   scale:0.88, thr:75 },
    { name:'ì‹¤ë¬´ì',    scale:1.02, thr:170 },
    { name:'ì—ì´ìŠ¤',    scale:1.22, thr:310 },
    { name:'í•µì‹¬ ì¸ë¬¼', scale:1.48, thr:490 },
    { name:'ê³ ì¸ë¬¼',    scale:1.80, thr:720 },
    { name:'ê±°ëŒ€ ë‹¬ìˆ˜', scale:2.30, thr:1000 },
  ],

  // í”Œë ˆì´ì–´ ê¸°ë³¸ í¬ê¸° (dalsu.pngì˜ ë Œë” í¬ê¸°)
  P_W: 72,
  P_H: 96,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìœ í‹¸ë¦¬í‹°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const lerp  = (a,b,t) => a+(b-a)*t;
const clamp = (v,lo,hi) => Math.max(lo,Math.min(hi,v));
const rand  = (lo,hi) => lo+Math.random()*(hi-lo);
const randI = (lo,hi) => Math.floor(rand(lo,hi+1));
const pick  = arr => arr[Math.floor(Math.random()*arr.length)];
const hsl   = (h,s,l,a=1) => `hsla(${h},${s}%,${l}%,${a})`;

// ì‹œë“œ ê¸°ë°˜ ì˜ì‚¬ ë‚œìˆ˜ (ê±´ë¬¼ ì¬í˜„ìš©)
function seededRand(seed){
  let s = seed;
  return ()=>{ s=(s*9301+49297)%233280; return s/233280; };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ìƒíƒœ ë¨¸ì‹ 
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ST = {
  LOADING:'LOADING', TITLE:'TITLE', PLAY:'PLAY',
  PAUSE:'PAUSE', EVENT:'EVENT', OVER:'OVER'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì‚¬ìš´ë“œ ë§¤ë‹ˆì € (WebAudio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Sound {
  constructor(){
    this.ctx = null;
    this.on = true;
  }
  ensure(){
    if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)();
    if(this.ctx.state==='suspended') this.ctx.resume();
  }
  tone(freq,dur,type='sine',vol=0.25){
    if(!this.on||!this.ctx) return;
    try{
      const o=this.ctx.createOscillator(), g=this.ctx.createGain();
      o.connect(g); g.connect(this.ctx.destination);
      o.type=type; o.frequency.value=freq;
      const t=this.ctx.currentTime;
      g.gain.setValueAtTime(vol,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+dur);
      o.start(t); o.stop(t+dur);
    }catch(e){}
  }
  noise(dur,vol=0.15){
    if(!this.on||!this.ctx) return;
    try{
      const sr=this.ctx.sampleRate, buf=this.ctx.createBuffer(1,sr*dur,sr);
      const d=buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*vol;
      const s=this.ctx.createBufferSource(), g=this.ctx.createGain();
      s.buffer=buf; s.connect(g); g.connect(this.ctx.destination);
      g.gain.setValueAtTime(vol,this.ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,this.ctx.currentTime+dur);
      s.start(); s.stop(this.ctx.currentTime+dur);
    }catch(e){}
  }
  jump(){
    this.tone(380,0.08,'square',0.15);
    setTimeout(()=>this.tone(520,0.06,'square',0.12),40);
  }
  hit(){
    this.noise(0.25,0.3);
    this.tone(80,0.3,'sawtooth',0.25);
  }
  grow(){
    this.tone(523,0.1,'sine',0.2);
    setTimeout(()=>this.tone(659,0.1,'sine',0.2),100);
    setTimeout(()=>this.tone(784,0.15,'sine',0.25),200);
  }
  giant(){
    this.tone(262,0.3,'sawtooth',0.2);
    setTimeout(()=>this.tone(330,0.2,'sine',0.3),150);
    setTimeout(()=>this.tone(523,0.4,'sine',0.3),300);
  }
  coffee(){
    this.tone(880,0.05,'sine',0.15);
    this.tone(1100,0.08,'sine',0.12);
  }
  pickup(){
    this.tone(700,0.06,'square',0.12);
    setTimeout(()=>this.tone(900,0.06,'square',0.12),60);
  }
  heartbeat(){
    this.tone(60,0.15,'sine',0.2);
    setTimeout(()=>this.tone(55,0.12,'sine',0.15),180);
  }
  brk(){
    this.noise(0.15,0.2);
    this.tone(200,0.1,'square',0.15);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì…ë ¥ ì²˜ë¦¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Input {
  constructor(game){
    this.G = game;
    this.held = {};
    this.mouseDown = false;
    this.clickPos = null;

    window.addEventListener('keydown', e => this.kd(e));
    window.addEventListener('keyup',   e => this.ku(e));
    const c = game.canvas;
    c.addEventListener('mousedown',  e => this.md(e));
    c.addEventListener('mouseup',    e => this.mu(e));
    c.addEventListener('touchstart', e => { e.preventDefault(); this.md(e.touches[0]); }, {passive:false});
    c.addEventListener('touchend',   e => { e.preventDefault(); this.mu(e); }, {passive:false});
  }

  canvasPos(e){
    const r = this.G.canvas.getBoundingClientRect();
    return {
      x: (e.clientX - r.left) / r.width * CFG.W,
      y: (e.clientY - r.top) / r.height * CFG.H
    };
  }

  kd(e){
    if(e.repeat) return;
    this.held[e.code] = true;
    const G = this.G;

    if(e.code==='Space') e.preventDefault();

    switch(G.state){
      case ST.TITLE:
        if(e.code==='Space') G.startGame();
        break;
      case ST.PLAY:
        if(e.code==='Space') G.player.requestJump();
        else if(e.code==='KeyP') G.pause();
        else if(e.code==='KeyR') G.restart();
        else if(e.code==='KeyM') G.snd.on=!G.snd.on;
        break;
      case ST.PAUSE:
        if(e.code==='KeyP'||e.code==='Space') G.unpause();
        break;
      case ST.OVER:
        if(e.code==='Space'||e.code==='KeyR') G.restart();
        break;
      case ST.EVENT:
        if(e.code==='Digit1'||e.code==='Numpad1') G.chooseEvent(0);
        else if(e.code==='Digit2'||e.code==='Numpad2') G.chooseEvent(1);
        break;
    }
  }

  ku(e){
    this.held[e.code] = false;
    if(this.G.state===ST.PLAY && e.code==='Space'){
      this.G.player.releaseJump();
    }
  }

  md(e){
    this.mouseDown = true;
    const G = this.G;
    G.snd.ensure();

    if(e.clientX !== undefined) this.clickPos = this.canvasPos(e);

    switch(G.state){
      case ST.TITLE: G.startGame(); break;
      case ST.PLAY:  G.player.requestJump(); break;
      case ST.OVER:  G.restart(); break;
      case ST.EVENT:
        if(this.clickPos){
          const cx = CFG.W/2, cy = CFG.H/2;
          if(this.clickPos.y > cy && this.clickPos.y < cy+70){
            if(this.clickPos.x < cx - 10) G.chooseEvent(0);
            else if(this.clickPos.x > cx + 10) G.chooseEvent(1);
          }
        }
        break;
    }
  }

  mu(e){
    this.mouseDown = false;
    if(this.G.state===ST.PLAY) this.G.player.releaseJump();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  íŒŒí‹°í´ ì‹œìŠ¤í…œ (í’€ë§)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Particle {
  constructor(){ this.active=false; }
  init(x,y,type){
    this.x=x; this.y=y; this.type=type; this.active=true; this.life=1;
    switch(type){
      case 'dust':
        this.vx=rand(-3,3); this.vy=rand(-4,-1);
        this.sz=rand(2,5); this.col='#9e9e9e'; this.dec=0.025; this.grav=0.15; break;
      case 'grow':
        this.vx=rand(-7,7); this.vy=rand(-7,7);
        this.sz=rand(4,10); this.col=pick(['#ffd700','#ffeb3b','#ff9800','#fff']); this.dec=0.018; this.grav=0; break;
      case 'score':
        this.vx=rand(-4,4); this.vy=rand(-5,-2);
        this.sz=rand(3,6); this.col='#4fc3f7'; this.dec=0.03; this.grav=0.1; break;
      case 'break':
        this.vx=rand(-8,8); this.vy=rand(-10,-2);
        this.sz=rand(3,8); this.col=pick(['#fff','#e0e0e0','#bdbdbd']); this.dec=0.02; this.grav=0.35; break;
      case 'coffee':
        this.vx=rand(-2,2); this.vy=rand(-3,-1);
        this.sz=rand(2,4); this.col='#795548'; this.dec=0.03; this.grav=0.05; break;
      case 'rain':
        this.vx=rand(-1,1); this.vy=rand(12,18);
        this.sz=rand(1,2); this.col='rgba(150,200,255,0.5)'; this.dec=0.008; this.grav=0; break;
      case 'snow':
        this.vx=rand(-1,1); this.vy=rand(1,3);
        this.sz=rand(2,4); this.col='rgba(255,255,255,0.7)'; this.dec=0.005; this.grav=0; break;
      case 'spark':
        this.vx=rand(-5,5); this.vy=rand(-8,-3);
        this.sz=rand(2,4); this.col='#ffeb3b'; this.dec=0.04; this.grav=0.2; break;
      default:
        this.vx=0;this.vy=-1;this.sz=3;this.col='#fff';this.dec=0.03;this.grav=0.1;
    }
  }
  update(dt){
    if(!this.active) return;
    this.x+=this.vx*dt; this.y+=this.vy*dt;
    this.vy+=this.grav*dt;
    this.life-=this.dec*dt;
    if(this.life<=0) this.active=false;
  }
  render(ctx){
    if(!this.active) return;
    ctx.globalAlpha=clamp(this.life,0,1);
    ctx.fillStyle=this.col;
    if(this.type==='rain'){
      ctx.fillRect(this.x,this.y,1,this.sz*4);
    } else {
      ctx.beginPath();
      ctx.arc(this.x,this.y,this.sz*this.life,0,Math.PI*2);
      ctx.fill();
    }
    ctx.globalAlpha=1;
  }
}

class Particles {
  constructor(){
    this.pool=[];
    for(let i=0;i<CFG.MAX_PARTICLES;i++) this.pool.push(new Particle());
  }
  spawn(x,y,type){
    for(const p of this.pool){
      if(!p.active){ p.init(x,y,type); return p; }
    }
    return null;
  }
  burst(x,y,type,count){
    for(let i=0;i<count;i++) this.spawn(x,y,type);
  }
  update(dt){
    for(const p of this.pool) if(p.active) p.update(dt);
  }
  render(ctx){
    for(const p of this.pool) if(p.active) p.render(ctx);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë°°ê²½ ë Œë”ëŸ¬ â€” íŒêµ í…Œí¬ë…¸ë°¸ë¦¬ "ê°€ì§œ 3D"
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Background {
  constructor(){
    this.farBuildings = this.genBuildings(12, 100, 260, 42);
    this.midBuildings = this.genBuildings(10, 80, 200, 77);
    this.nearElements = this.genStreet(20, 123);
    this.scroll = [0, 0, 0, 0];
  }

  genBuildings(count, minH, maxH, seed){
    const r = seededRand(seed);
    const arr = [];
    let x = 0;
    for(let i=0;i<count;i++){
      const w = 50 + r()*90;
      const h = minH + r()*(maxH-minH);
      const hue = pick([210,215,220,200,195]);
      const sat = 15 + r()*25;
      const lit = 25 + r()*20;
      const floors = Math.floor(h/22);
      const cols = Math.max(2, Math.floor(w/18));
      const hasSign = r()>0.55;
      const signHue = r()*360;
      const depth = 8 + r()*12;
      arr.push({x, w, h, hue, sat, lit, floors, cols, hasSign, signHue, depth,
                windowPattern: Array.from({length:floors*cols}, ()=>r()>0.4) });
      x += w + 8 + r()*35;
    }
    return arr;
  }

  genStreet(count, seed){
    const r = seededRand(seed);
    const arr = [];
    let x = 0;
    for(let i=0;i<count;i++){
      const type = pick(['lamp','tree','busstop','person','person','tree','lamp']);
      arr.push({x, type, h: 40+r()*30, flip: r()>0.5});
      x += 60 + r()*100;
    }
    return arr;
  }

  totalWidth(buildings){
    if(!buildings.length) return 1;
    const last = buildings[buildings.length-1];
    return last.x + last.w + 40;
  }

  update(speed, dt){
    this.scroll[0] += speed * 0.12 * dt;
    this.scroll[1] += speed * 0.3  * dt;
    this.scroll[2] += speed * 0.55 * dt;
    this.scroll[3] += speed * 1.0  * dt;
  }

  render(ctx, timeOfDay, weather){
    this.renderSky(ctx, timeOfDay);
    this.renderStars(ctx, timeOfDay);
    this.renderBuildingLayer(ctx, this.farBuildings, this.scroll[0], 0.55, timeOfDay, CFG.GROUND-10);
    this.renderBuildingLayer(ctx, this.midBuildings, this.scroll[1], 0.75, timeOfDay, CFG.GROUND);
    this.renderRoad(ctx, this.scroll[3], timeOfDay);
    this.renderStreet(ctx, this.scroll[2], timeOfDay);
    if(weather) this.renderWeather(ctx, weather);
  }

  renderSky(ctx, t){
    const colors = [
      {r:255,g:170,b:100}, // 0.0 ì•„ì¹¨
      {r:135,g:200,b:240}, // 0.25 ë‚®
      {r:255,g:120,b:70},  // 0.5 ì €ë…
      {r:15,g:15,b:45},    // 0.75 ë°¤
      {r:255,g:170,b:100}, // 1.0 ë‹¤ì‹œ ì•„ì¹¨
    ];
    const idx = t * (colors.length-1);
    const i = Math.floor(idx);
    const f = idx - i;
    const c1 = colors[Math.min(i, colors.length-1)];
    const c2 = colors[Math.min(i+1, colors.length-1)];
    const r = lerp(c1.r,c2.r,f)|0;
    const g = lerp(c1.g,c2.g,f)|0;
    const b = lerp(c1.b,c2.b,f)|0;

    const grad = ctx.createLinearGradient(0,0,0,CFG.GROUND);
    grad.addColorStop(0, `rgb(${r},${g},${b})`);
    grad.addColorStop(1, `rgb(${(r*0.4)|0},${(g*0.4)|0},${(b*0.4)|0})`);
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,CFG.W,CFG.GROUND);
  }

  renderStars(ctx, t){
    const nightAlpha = t>0.6 ? Math.min((t-0.6)/0.15, 1) : t<0.1 ? Math.max(1-t/0.1,0) : 0;
    if(nightAlpha<0.05) return;
    ctx.fillStyle = `rgba(255,255,255,${nightAlpha*0.7})`;
    const sr = seededRand(999);
    for(let i=0;i<40;i++){
      const sx = sr()*CFG.W, sy = sr()*(CFG.GROUND*0.5);
      const ss = 0.5+sr()*1.5;
      const twinkle = Math.sin(performance.now()/300+i)*0.3+0.7;
      ctx.globalAlpha = nightAlpha*twinkle*0.8;
      ctx.beginPath(); ctx.arc(sx,sy,ss,0,Math.PI*2); ctx.fill();
    }
    ctx.globalAlpha=1;
  }

  renderBuildingLayer(ctx, buildings, scroll, opacity, timeOfDay, baseY){
    const tw = this.totalWidth(buildings);
    const off = scroll % tw;
    const isNight = timeOfDay > 0.6 || timeOfDay < 0.1;

    ctx.save();
    ctx.globalAlpha = opacity;

    for(let pass=0; pass<2; pass++){
      const ox = -off + pass * tw;
      for(const b of buildings){
        const bx = ox + b.x;
        if(bx + b.w < -50 || bx > CFG.W+50) continue;
        const by = baseY;

        // ì¸¡ë©´ (3D ê¹Šì´)
        ctx.fillStyle = hsl(b.hue, b.sat, Math.max(5,b.lit-15));
        ctx.beginPath();
        ctx.moveTo(bx+b.w, by);
        ctx.lineTo(bx+b.w, by-b.h);
        ctx.lineTo(bx+b.w+b.depth, by-b.h-b.depth*0.6);
        ctx.lineTo(bx+b.w+b.depth, by-b.depth*0.3);
        ctx.closePath();
        ctx.fill();

        // ì§€ë¶•ë©´
        ctx.fillStyle = hsl(b.hue, b.sat, Math.max(5,b.lit-8));
        ctx.beginPath();
        ctx.moveTo(bx, by-b.h);
        ctx.lineTo(bx+b.depth, by-b.h-b.depth*0.6);
        ctx.lineTo(bx+b.w+b.depth, by-b.h-b.depth*0.6);
        ctx.lineTo(bx+b.w, by-b.h);
        ctx.closePath();
        ctx.fill();

        // ì •ë©´
        const grad = ctx.createLinearGradient(bx, by-b.h, bx+b.w, by);
        grad.addColorStop(0, hsl(b.hue, b.sat, b.lit+5));
        grad.addColorStop(1, hsl(b.hue, b.sat, b.lit-3));
        ctx.fillStyle = grad;
        ctx.fillRect(bx, by-b.h, b.w, b.h);

        // ìœ ë¦¬ ë°˜ì‚¬ í•˜ì´ë¼ì´íŠ¸
        ctx.fillStyle = `rgba(255,255,255,0.04)`;
        ctx.fillRect(bx+2, by-b.h+2, b.w*0.4, b.h-4);

        // ì°½ë¬¸
        const ww = (b.w-8) / b.cols;
        const wh = (b.h-10) / b.floors;
        for(let fy=0; fy<b.floors; fy++){
          for(let fx=0; fx<b.cols; fx++){
            const wx = bx + 4 + fx*ww + 2;
            const wy = by - b.h + 5 + fy*wh + 2;
            const lit = b.windowPattern[fy*b.cols+fx];
            if(isNight && lit){
              ctx.fillStyle = hsl(45+Math.random()*10, 80, 65, 0.85);
              ctx.shadowColor = '#ffd700';
              ctx.shadowBlur = 4;
            } else {
              ctx.fillStyle = hsl(b.hue, b.sat+10, isNight?b.lit-10:b.lit+15, 0.6);
              ctx.shadowBlur = 0;
            }
            ctx.fillRect(wx, wy, ww-4, wh-4);
            ctx.shadowBlur = 0;
          }
        }

        // ê°„íŒ
        if(b.hasSign){
          const sw = 20+Math.random()*15, sh = 12;
          const sx = bx + b.w/2 - sw/2;
          const sy = by - b.h*0.3;
          ctx.fillStyle = hsl(b.signHue, 60, 55, 0.8);
          ctx.fillRect(sx, sy, sw, sh);
          ctx.fillStyle = '#fff';
          ctx.font = '8px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(pick(['TX','NV','KT','SG','DP','AI']), sx+sw/2, sy+9);
        }
      }
    }
    ctx.restore();
  }

  renderRoad(ctx, scroll, tod){
    const gy = CFG.GROUND;
    const rh = CFG.H - gy;

    // ë³´ë„
    ctx.fillStyle = hsl(30,5,30);
    ctx.fillRect(0, gy, CFG.W, rh);

    // ë„ë¡œ (ì›ê·¼ ì‚¬ë‹¤ë¦¬ê¼´)
    const grad = ctx.createLinearGradient(0, gy, 0, CFG.H);
    grad.addColorStop(0, '#3a3a3a');
    grad.addColorStop(1, '#2a2a2a');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.moveTo(0, gy+15);
    ctx.lineTo(CFG.W, gy+15);
    ctx.lineTo(CFG.W, CFG.H);
    ctx.lineTo(0, CFG.H);
    ctx.closePath();
    ctx.fill();

    // ì°¨ì„ 
    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
    ctx.setLineDash([40,30]);
    ctx.lineWidth = 2;
    const laneY = gy + 15 + rh*0.45;
    const off = scroll % 70;
    ctx.beginPath();
    ctx.moveTo(-off, laneY);
    ctx.lineTo(CFG.W+70, laneY);
    ctx.stroke();
    ctx.setLineDash([]);

    // íš¡ë‹¨ë³´ë„
    ctx.fillStyle = 'rgba(255,255,255,0.25)';
    const cwOff = scroll % 600;
    for(let i=-1;i<3;i++){
      const cx = i*600 - cwOff;
      for(let s=0;s<5;s++){
        ctx.fillRect(cx+s*14, gy+16, 10, rh-18);
      }
    }

    // ì¸ë„ ê²½ê³„ì„
    ctx.fillStyle = '#555';
    ctx.fillRect(0, gy+12, CFG.W, 4);
  }

  renderStreet(ctx, scroll, tod){
    const tw = this.nearElements.reduce((mx,e)=>Math.max(mx,e.x+80),0) || 1;
    const off = scroll % (tw+200);
    const isNight = tod>0.6||tod<0.1;

    for(let pass=0;pass<2;pass++){
      const ox = -off + pass*(tw+200);
      for(const el of this.nearElements){
        const ex = ox + el.x;
        if(ex<-80||ex>CFG.W+80) continue;
        const ey = CFG.GROUND;

        switch(el.type){
          case 'lamp':
            ctx.fillStyle = '#666';
            ctx.fillRect(ex, ey-90, 4, 90);
            ctx.fillStyle = '#888';
            ctx.fillRect(ex-6, ey-92, 16, 5);
            if(isNight){
              const lg = ctx.createRadialGradient(ex+2,ey-87,0,ex+2,ey-87,50);
              lg.addColorStop(0,'rgba(255,230,150,0.25)');
              lg.addColorStop(1,'rgba(255,230,150,0)');
              ctx.fillStyle = lg;
              ctx.fillRect(ex-48,ey-137,100,100);
            }
            break;
          case 'tree':
            ctx.fillStyle = '#5d4037';
            ctx.fillRect(ex+6, ey-45, 6, 45);
            ctx.fillStyle = hsl(120,35,30);
            ctx.beginPath();
            ctx.arc(ex+9, ey-55, 18, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = hsl(120,40,35,0.6);
            ctx.beginPath();
            ctx.arc(ex+4, ey-48, 12, 0, Math.PI*2);
            ctx.fill();
            break;
          case 'busstop':
            ctx.fillStyle = '#78909c';
            ctx.fillRect(ex, ey-55, 30, 55);
            ctx.fillStyle = '#b0bec5';
            ctx.fillRect(ex-3, ey-58, 36, 6);
            ctx.fillStyle = '#42a5f5';
            ctx.fillRect(ex+5, ey-48, 20, 15);
            break;
          case 'person':
            ctx.fillStyle = `rgba(0,0,0,${isNight?0.3:0.15})`;
            const ph = 20+el.h*0.3;
            ctx.fillRect(ex, ey-ph, 6, ph);
            ctx.beginPath();
            ctx.arc(ex+3, ey-ph-4, 4, 0, Math.PI*2);
            ctx.fill();
            break;
        }
      }
    }
  }

  renderWeather(ctx, w){
    if(w.type==='dust'){
      ctx.fillStyle = `rgba(180,160,100,${w.intensity*0.15})`;
      ctx.fillRect(0,0,CFG.W,CFG.H);
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  í”Œë ˆì´ì–´ â€” ë‹¬ìˆ˜
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Player {
  constructor(game){
    this.G = game;
    this.x = 180;
    this.y = CFG.GROUND;
    this.vy = 0;
    this.grounded = true;
    this.jumping = false;
    this.holdingJump = false;

    this.coyote = 0;
    this.jumpBuf = 0;

    this.scale = CFG.STAGES[0].scale;
    this.targetScale = this.scale;

    // ì ˆì°¨ì  ì• ë‹ˆë©”ì´ì…˜ ìƒíƒœ
    this.runPhase = 0;
    this.squash = 1;
    this.stretch = 1;
    this.tilt = 0;
    this.bobY = 0;

    // ìŠ¤í”„ë¼ì´íŠ¸ ì‹œíŠ¸ ì •ë³´
    this.frameCount = 1;
    this.frameW = 0;
    this.frameH = 0;
    this.frameIdx = 0;
    this.frameTimer = 0;

    // ë¬´ì 
    this.invincible = 0;

    // ê±°ëŒ€ ëª¨ë“œ
    this.giantMode = false;
    this.giantTimer = 0;
  }

  get w(){ return CFG.P_W * this.scale; }
  get h(){ return CFG.P_H * this.scale; }

  initSprite(img){
    const ratio = img.width / img.height;
    if(ratio > 1.8){
      this.frameCount = Math.round(ratio);
      this.frameW = img.width / this.frameCount;
      this.frameH = img.height;
    } else {
      this.frameCount = 1;
      this.frameW = img.width;
      this.frameH = img.height;
    }
  }

  requestJump(){
    if(this.coyote > 0 && !this.jumping){
      this.jump();
    } else {
      this.jumpBuf = CFG.JUMP_BUF;
    }
    this.holdingJump = true;
  }

  releaseJump(){
    this.holdingJump = false;
    if(this.vy < 0) this.vy *= 0.5;
  }

  jump(){
    const boost = 1 + (this.scale - 0.7) * 0.15;
    this.vy = CFG.JUMP * boost;
    this.jumping = true;
    this.grounded = false;
    this.coyote = 0;

    this.squash = 0.75;
    this.stretch = 1.25;

    this.G.particles.burst(this.x, this.y, 'dust', 6);
    this.G.snd.jump();
  }

  update(dt){
    // ìŠ¤ì¼€ì¼ ë³´ê°„
    this.targetScale = CFG.STAGES[this.G.stage].scale;
    this.scale = lerp(this.scale, this.targetScale, 0.08*dt);

    // ì¤‘ë ¥
    this.vy += CFG.GRAVITY * dt;

    // ê°€ë³€ ì í”„ (í™€ë“œ ì‹œ ë” ë†’ì´)
    if(this.holdingJump && this.vy < 0){
      this.vy += CFG.JUMP_HOLD * dt;
    }

    this.y += this.vy * dt;

    // ì°©ì§€
    if(this.y >= CFG.GROUND){
      this.y = CFG.GROUND;
      if(!this.grounded){
        this.grounded = true;
        this.jumping = false;
        this.squash = 1.2;
        this.stretch = 0.8;
        const shake = Math.min(this.scale * 2.5, 8);
        this.G.cameraShake = Math.max(this.G.cameraShake, shake);
        this.G.particles.burst(this.x, this.y, 'dust', Math.ceil(4*this.scale));
      }
      this.vy = 0;
      this.coyote = CFG.COYOTE;
    } else {
      if(this.grounded) this.grounded = false;
    }

    if(this.coyote > 0) this.coyote -= dt * 16.67;

    // ì í”„ ë²„í¼
    if(this.jumpBuf > 0){
      this.jumpBuf -= dt * 16.67;
      if(this.coyote > 0 && !this.jumping){
        this.jump();
        this.jumpBuf = 0;
      }
    }

    // ìŠ¤ì¿¼ì‹œ/ìŠ¤íŠ¸ë ˆì¹˜ ë³µê·€
    this.squash = lerp(this.squash, 1, 0.15*dt);
    this.stretch = lerp(this.stretch, 1, 0.15*dt);

    // ë‹¬ë¦¬ê¸° ì ˆì°¨ì  ì• ë‹ˆë©”ì´ì…˜
    const spd = this.G.speed;
    this.runPhase += spd * 0.018 * dt;
    this.bobY = this.grounded ? Math.sin(this.runPhase * 2) * 3 : 0;
    this.tilt = this.grounded ? Math.sin(this.runPhase) * 0.04 : (this.vy < 0 ? -0.08 : 0.06);

    // ìŠ¤í”„ë¼ì´íŠ¸ ì‹œíŠ¸ í”„ë ˆì„ ì§„í–‰
    if(this.frameCount > 1){
      this.frameTimer += spd * dt * 0.5;
      if(this.frameTimer > 5){
        this.frameTimer = 0;
        this.frameIdx = (this.frameIdx + 1) % this.frameCount;
      }
    }

    // ë¬´ì  íƒ€ì´ë¨¸
    if(this.invincible > 0) this.invincible -= dt * 16.67;

    // ê±°ëŒ€ ëª¨ë“œ
    if(this.giantMode){
      this.giantTimer -= dt * 16.67;
      if(this.giantTimer <= 0) this.giantMode = false;
    }
  }

  render(ctx){
    const img = this.G.dalsuImg;
    const loaded = this.G.imgLoaded;

    ctx.save();
    ctx.translate(this.x, this.y + this.bobY);
    ctx.rotate(this.tilt);
    ctx.scale(this.squash, this.stretch);

    const dw = this.w;
    const dh = this.h;

    // ë¬´ì  ì‹œ ê¹œë¹¡ì„
    if(this.invincible > 0 && Math.sin(performance.now()/50)>0){
      ctx.globalAlpha = 0.4;
    }

    // ê±°ëŒ€ ëª¨ë“œ ì˜¤ë¼
    if(this.giantMode || this.G.stage >= 6){
      const glowR = dw * 1.2;
      const grd = ctx.createRadialGradient(0, -dh/2, dw*0.2, 0, -dh/2, glowR);
      const pulse = Math.sin(performance.now()/200)*0.15 + 0.25;
      grd.addColorStop(0, `rgba(255,215,0,${pulse})`);
      grd.addColorStop(0.5, `rgba(255,170,0,${pulse*0.4})`);
      grd.addColorStop(1, 'rgba(255,215,0,0)');
      ctx.fillStyle = grd;
      ctx.beginPath();
      ctx.arc(0, -dh/2, glowR, 0, Math.PI*2);
      ctx.fill();
    }

    if(loaded){
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      if(this.frameCount > 1){
        ctx.drawImage(img,
          this.frameIdx * this.frameW, 0, this.frameW, this.frameH,
          -dw/2, -dh, dw, dh
        );
      } else {
        ctx.drawImage(img, -dw/2, -dh, dw, dh);
      }
    } else {
      this.renderFallback(ctx, dw, dh);
    }

    ctx.restore();
  }

  renderFallback(ctx, dw, dh){
    // ì´ë¯¸ì§€ ë¯¸ë¡œë“œ ì‹œ ìˆ˜ë‹¬ ì‹¤ë£¨ì—£
    ctx.fillStyle = '#6d4c41';
    ctx.beginPath();
    ctx.ellipse(0, -dh*0.45, dw*0.35, dh*0.45, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = '#8d6e63';
    ctx.beginPath();
    ctx.arc(0, -dh*0.78, dw*0.28, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = '#d7ccc8';
    ctx.beginPath();
    ctx.ellipse(0, -dh*0.65, dw*0.18, dh*0.12, 0, 0, Math.PI*2);
    ctx.fill();

    ctx.fillStyle = '#222';
    ctx.beginPath(); ctx.arc(-dw*0.1, -dh*0.82, 3, 0, Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc( dw*0.1, -dh*0.82, 3, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = '#333';
    ctx.beginPath(); ctx.arc(0, -dh*0.75, 3.5, 0, Math.PI*2); ctx.fill();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì¥ì• ë¬¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OBS_TYPES = [
  {id:'meeting', name:'ê¸´ê¸‰ íšŒì˜', w:55, h:75,  color:'#26c6da', icon:'ğŸ“‹', stressAdd:5},
  {id:'email',   name:'ë©”ì¼ í­íƒ„', w:35, h:50,  color:'#ef5350', icon:'ğŸ“§', stressAdd:3, multi:true},
  {id:'kpi',     name:'KPI ë²½',   w:45, h:130,  color:'#78909c', icon:'ğŸ“Š', stressAdd:8, breakable:true},
  {id:'kakao',   name:'ìƒì‚¬ ì¹´í†¡', w:60, h:65,  color:'#fdd835', icon:'ğŸ’¬', stressAdd:6, tracking:true},
  {id:'deadline',name:'ë§ˆê° í­íƒ„', w:50, h:60,  color:'#ff7043', icon:'ğŸ’£', stressAdd:10, timed:true},
  {id:'subway',  name:'ì¶œê·¼ ëŸ¬ì‹œ', w:120,h:45,  color:'#9e9e9e', icon:'ğŸš‡', stressAdd:4},
];

class Obstacle {
  constructor(game, x, typeData){
    this.G = game;
    this.x = x;
    this.y = CFG.GROUND;
    this.td = typeData;
    this.w = typeData.w;
    this.h = typeData.h;
    this.passed = false;
    this.alive = true;
    this.warned = false;
    this.timer = 0;
    this.spawnTime = performance.now();
    this.exploded = false;
    this.trackVy = 0;
    this.trackTimer = 0;
    this.alpha = 1;

    if(typeData.tracking){
      this.y = CFG.GROUND - 60 - Math.random()*60;
      this.trackTimer = 3500;
    }
    if(typeData.timed){
      this.timer = 1500;
    }
  }

  update(dt){
    if(!this.alive) return;
    const spd = this.G.speed;

    if(this.td.tracking){
      this.x -= spd * 0.4 * dt;
      const py = this.G.player.y - this.G.player.h*0.5;
      this.y = lerp(this.y, py, 0.015*dt);
      this.trackTimer -= dt*16.67;
      if(this.trackTimer <= 0){
        this.alive = false;
        this.G.score += 30;
        this.G.addComboText('íšŒí”¼ ì„±ê³µ!');
      }
    } else {
      this.x -= spd * dt;
    }

    if(this.td.timed && !this.exploded){
      this.timer -= dt*16.67;
      if(this.timer <= 0){
        this.exploded = true;
        this.w = 110;
        this.h = 110;
        this.y = CFG.GROUND;
        this.G.particles.burst(this.x+this.w/2, this.y-this.h/2, 'spark', 12);
        setTimeout(()=>{ this.alive = false; }, 400);
      }
    }

    if(this.x + this.w < -50) this.alive = false;
  }

  canBreak(){
    return this.td.breakable && (this.G.stage >= 4 || this.G.player.giantMode);
  }

  render(ctx){
    if(!this.alive) return;

    const ex = this.x, ey = this.y;
    ctx.save();

    // ê²½ê³  í‘œì‹œ (ì¥ì• ë¬¼ì´ í™”ë©´ì— ì§„ì… ì „)
    if(this.x > CFG.W - 100){
      ctx.globalAlpha = 0.6 + Math.sin(performance.now()/100)*0.3;
      ctx.fillStyle = '#ff5252';
      ctx.font = 'bold 20px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('âš ', CFG.W - 30, ey - this.h/2);
      ctx.globalAlpha = 1;
    }

    // ë§ˆê° í­íƒ„ ê²½ê³ 
    if(this.td.timed && !this.exploded){
      const prog = this.timer / 1500;
      ctx.strokeStyle = `rgba(255,0,0,${1-prog})`;
      ctx.lineWidth = 3;
      ctx.setLineDash([4,4]);
      ctx.strokeRect(ex-15, ey-this.h-15, this.w+30, this.h+30);
      ctx.setLineDash([]);
    }

    if(this.exploded){
      const pulse = Math.sin(performance.now()/30)*0.3+0.7;
      ctx.fillStyle = `rgba(255,100,0,${pulse*0.5})`;
      ctx.beginPath();
      ctx.arc(ex+this.w/2, ey-this.h/2, this.w/2, 0, Math.PI*2);
      ctx.fill();
    }

    // ì¥ì• ë¬¼ ëª¸ì²´ â€” ì…ì²´ê° í‘œí˜„
    const depth = 6;

    // ì¸¡ë©´
    ctx.fillStyle = this.darken(this.td.color, 0.7);
    ctx.beginPath();
    ctx.moveTo(ex+this.w, ey);
    ctx.lineTo(ex+this.w, ey-this.h);
    ctx.lineTo(ex+this.w+depth, ey-this.h-depth*0.5);
    ctx.lineTo(ex+this.w+depth, ey-depth*0.3);
    ctx.closePath();
    ctx.fill();

    // ìƒë©´
    ctx.fillStyle = this.darken(this.td.color, 1.15);
    ctx.beginPath();
    ctx.moveTo(ex, ey-this.h);
    ctx.lineTo(ex+depth, ey-this.h-depth*0.5);
    ctx.lineTo(ex+this.w+depth, ey-this.h-depth*0.5);
    ctx.lineTo(ex+this.w, ey-this.h);
    ctx.closePath();
    ctx.fill();

    // ì •ë©´
    const grd = ctx.createLinearGradient(ex, ey-this.h, ex, ey);
    grd.addColorStop(0, this.darken(this.td.color, 1.1));
    grd.addColorStop(1, this.td.color);
    ctx.fillStyle = grd;
    ctx.fillRect(ex, ey-this.h, this.w, this.h);

    // í…Œë‘ë¦¬
    ctx.strokeStyle = 'rgba(0,0,0,0.2)';
    ctx.lineWidth = 2;
    ctx.strokeRect(ex, ey-this.h, this.w, this.h);

    // íŒŒê´´ ê°€ëŠ¥ í‘œì‹œ
    if(this.canBreak()){
      ctx.strokeStyle = 'rgba(255,215,0,0.6)';
      ctx.lineWidth = 2;
      ctx.setLineDash([3,3]);
      ctx.strokeRect(ex-2, ey-this.h-2, this.w+4, this.h+4);
      ctx.setLineDash([]);
    }

    // ì•„ì´ì½˜ + ì´ë¦„
    ctx.textAlign = 'center';
    ctx.font = `${Math.min(24, this.w*0.5)}px sans-serif`;
    ctx.fillText(this.td.icon, ex+this.w/2, ey-this.h/2+4);
    ctx.fillStyle = 'rgba(255,255,255,0.85)';
    ctx.font = 'bold 10px Malgun Gothic';
    ctx.fillText(this.td.name, ex+this.w/2, ey-4);

    ctx.restore();
  }

  darken(hex, factor){
    const m = hex.match(/^#(..)(..)(..)/);
    if(!m) return hex;
    const r=clamp(parseInt(m[1],16)*factor,0,255)|0;
    const g=clamp(parseInt(m[2],16)*factor,0,255)|0;
    const b=clamp(parseInt(m[3],16)*factor,0,255)|0;
    return `rgb(${r},${g},${b})`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì•„ì´í…œ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ITEM_TYPES = [
  {id:'coffee',  name:'ì»¤í”¼',      icon:'â˜•', color:'#795548',
   desc:'ìŠ¤íŠ¸ë ˆìŠ¤â†“ + ì§‘ì¤‘ ëª¨ë“œ 5ì´ˆ'},
  {id:'praise',  name:'ì¹­ì°¬ ìŠ¤í‹°ì»¤', icon:'â­', color:'#ffc107',
   desc:'ì½¤ë³´ ì‹œê°„ ì—°ì¥'},
  {id:'welfare', name:'ë³µì§€ í¬ì¸íŠ¸', icon:'ğŸ’š', color:'#66bb6a',
   desc:'ìŠ¤íŠ¸ë ˆìŠ¤ í¬ê²Œ ê°ì†Œ (í¬ê·€)'},
  {id:'overtime_pay', name:'ì•¼ê·¼ ìˆ˜ë‹¹', icon:'ğŸ’°', color:'#ff9800',
   desc:'ì ìˆ˜ ë°°ìœ¨â†‘, ìŠ¤íŠ¸ë ˆìŠ¤ ì†Œí­â†‘'},
  {id:'resign',  name:'í‡´ì‚¬ ë²„íŠ¼', icon:'ğŸšª', color:'#e91e63',
   desc:'1íšŒ ë¬´ì , ì„±ì¥ ê²Œì´ì§€â†“'},
];

class Item {
  constructor(game, x){
    this.G = game;
    this.x = x;
    this.y = CFG.GROUND - 30 - Math.random()*60;
    this.td = pick(ITEM_TYPES);
    if(this.td.id==='welfare' && Math.random()>0.3){
      this.td = ITEM_TYPES[0];
    }
    this.alive = true;
    this.sz = 28;
    this.bobPhase = Math.random()*Math.PI*2;
  }
  update(dt){
    this.x -= this.G.speed * dt;
    this.bobPhase += 0.05*dt;
    if(this.x < -50) this.alive = false;
  }
  render(ctx){
    if(!this.alive) return;
    const by = this.y + Math.sin(this.bobPhase)*6;
    ctx.save();

    // ë¹›ë‚¨ íš¨ê³¼
    const grd = ctx.createRadialGradient(this.x, by, 0, this.x, by, this.sz);
    grd.addColorStop(0, this.td.color+'66');
    grd.addColorStop(1, this.td.color+'00');
    ctx.fillStyle = grd;
    ctx.beginPath(); ctx.arc(this.x, by, this.sz, 0, Math.PI*2); ctx.fill();

    ctx.font = '22px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(this.td.icon, this.x, by+7);
    ctx.restore();
  }
  collect(){
    const G = this.G;
    this.alive = false;
    G.particles.burst(this.x, this.y, 'coffee', 8);
    G.snd.pickup();

    switch(this.td.id){
      case 'coffee':
        G.stress = Math.max(0, G.stress + CFG.STR_COFFEE);
        G.focusMode = 5000;
        G.addComboText('â˜• ì§‘ì¤‘ ëª¨ë“œ!');
        break;
      case 'praise':
        G.comboTimeBonus += 1500;
        G.addComboText('â­ ì½¤ë³´ ì‹œê°„ ì—°ì¥!');
        break;
      case 'welfare':
        G.stress = Math.max(0, G.stress - 50);
        G.addComboText('ğŸ’š íë§ íƒ€ì„!');
        break;
      case 'overtime_pay':
        G.scoreMultTimer = 8000;
        G.scoreMult = 2;
        G.stress = Math.min(100, G.stress + 8);
        G.addComboText('ğŸ’° ì•¼ê·¼ ìˆ˜ë‹¹ x2!');
        break;
      case 'resign':
        G.player.invincible = 5000;
        G.growthPts = Math.max(0, G.growthPts - 40);
        G.addComboText('ğŸšª í‡´ì‚¬ ê°?! (ë¬´ì  5ì´ˆ)');
        break;
    }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì„ íƒ ì´ë²¤íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const EVENTS = [
  {
    title: 'íšŒì‹ ì°¸ì„?',
    a: {text:'ì°¸ì„ (ìŠ¤íŠ¸ë ˆìŠ¤â†“, ë‚œì´ë„â†‘)', fn: G=>{G.stress=Math.max(0,G.stress-20); G.diffBonus+=0.15;}},
    b: {text:'ë¶ˆì°¸ (ìŠ¤íŠ¸ë ˆìŠ¤â†‘, ì„±ì¥â†‘)',     fn: G=>{G.stress=Math.min(100,G.stress+10); G.growthPts+=30;}}
  },
  {
    title: 'ê¸‰í•œ ë²„ê·¸ ë°œìƒ!',
    a: {text:'í•´ê²° (ì ìˆ˜â†‘, ìŠ¤íŠ¸ë ˆìŠ¤â†‘)', fn: G=>{G.score+=80; G.stress=Math.min(100,G.stress+15);}},
    b: {text:'ë„˜ê¸°ê¸° (ìŠ¤íŠ¸ë ˆìŠ¤â†“, KPIâ†“)', fn: G=>{G.stress=Math.max(0,G.stress-10); G.growthPts=Math.max(0,G.growthPts-15);}}
  },
  {
    title: 'ë¦¬ë”ê°€ ì ì‹¬ ì‚¬ì¤Œ',
    a: {text:'ê°ì‚¬íˆ ë¨¹ê¸° (ìŠ¤íŠ¸ë ˆìŠ¤â†“)',  fn: G=>{G.stress=Math.max(0,G.stress-15);}},
    b: {text:'ì‚¬ì–‘ (ì„±ì¥â†‘)',            fn: G=>{G.growthPts+=20;}}
  },
  {
    title: 'ìƒˆ í”„ë¡œì íŠ¸ ì œì•ˆ',
    a: {text:'ìˆ˜ë½ (ì„±ì¥â†‘â†‘, ìŠ¤íŠ¸ë ˆìŠ¤â†‘)', fn: G=>{G.growthPts+=40; G.stress=Math.min(100,G.stress+20);}},
    b: {text:'ê±°ì ˆ (ì•ˆì •)',              fn: G=>{G.stress=Math.max(0,G.stress-5);}}
  },
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì½¤ë³´ í…ìŠ¤íŠ¸ íŒì—…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class FloatText {
  constructor(text, x, y, color='#fff'){
    this.text=text; this.x=x; this.y=y; this.color=color;
    this.life=1; this.vy=-1.8;
  }
  update(dt){
    this.y += this.vy*dt;
    this.life -= 0.015*dt;
  }
  render(ctx){
    if(this.life<=0) return;
    ctx.save();
    ctx.globalAlpha = clamp(this.life,0,1);
    ctx.fillStyle = this.color;
    ctx.font = 'bold 22px Malgun Gothic';
    ctx.textAlign = 'center';
    ctx.fillText(this.text, this.x, this.y);
    ctx.restore();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë©”ì¸ ê²Œì„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Game {
  constructor(){
    this.canvas = document.getElementById('c');
    this.ctx = this.canvas.getContext('2d');

    // DPR
    this.dpr = Math.min(window.devicePixelRatio||1, 2);
    this.canvas.width = CFG.W * this.dpr;
    this.canvas.height = CFG.H * this.dpr;
    this.ctx.scale(this.dpr, this.dpr);

    this.state = ST.LOADING;

    // ì´ë¯¸ì§€ ë¡œë“œ
    this.dalsuImg = new Image();
    this.imgLoaded = false;
    this.imgFailed = false;
    this.dalsuImg.onload = ()=>{
      this.imgLoaded = true;
      this.player.initSprite(this.dalsuImg);
    };
    this.dalsuImg.onerror = ()=>{ this.imgFailed = true; };
    this.dalsuImg.src = 'dalsu.png';

    // ì‚¬ìš´ë“œ
    this.snd = new Sound();

    // ë°°ê²½
    this.bg = new Background();

    // íŒŒí‹°í´
    this.particles = new Particles();

    // ì…ë ¥
    this.input = new Input(this);

    // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
    this.player = new Player(this);
    this.obstacles = [];
    this.items = [];
    this.floatTexts = [];

    this.score = 0;
    this.best = parseInt(localStorage.getItem('dalsuBest')||'0');
    this.speed = CFG.BASE_SPD;
    this.stage = 0;
    this.growthPts = 0;
    this.combo = 0;
    this.lastComboTime = 0;
    this.comboTimeBonus = 0;
    this.stress = 0;
    this.burnout = false;
    this.burnoutTimer = 0;
    this.burnoutUsed = false;

    this.dayTime = 0.05;
    this.daySpeed = 1/CFG.DAY_LENGTH;
    this.isOvertime = false;

    this.weather = null;
    this.weatherTimer = CFG.WEATHER_INTERVAL;

    this.focusMode = 0;
    this.scoreMult = 1;
    this.scoreMultTimer = 0;
    this.diffBonus = 0;

    this.obsTimer = 0;
    this.nextObsDelay = rand(CFG.OBS_MIN, CFG.OBS_MAX);

    this.eventCooldown = 0;
    this.currentEvent = null;
    this.eventTimer = 0;
    this.lastEventScore = 0;

    this.cameraShake = 0;
    this.cameraZoom = 1;
    this.targetZoom = 1;
    this.timeScale = 1;

    this.comboTexts = [
      'ì„±ê³¼ ë‹¬ì„±!','ì¸ì • ë°›ìŒ!','ìŠ¹ì§„ê°?','í•´ëƒˆë‹¤!','ì—°ë´‰ í˜‘ìƒ ê°€ì!',
      'PROê¸‰!','ë ˆì „ë“œ!','ì£¼ì‹ ì‚¬ì!','ì˜¤ëŠ˜ì€ ì¹¼í‡´!'
    ];

    this.lastTime = 0;

    // ë¦¬ì‚¬ì´ì¦ˆ
    window.addEventListener('resize', ()=>this.resize());
    this.resize();

    // ë¡œë”© í›„ íƒ€ì´í‹€ë¡œ
    setTimeout(()=>{
      if(this.state===ST.LOADING) this.state=ST.TITLE;
    }, 1500);

    // ë©”ì¸ ë£¨í”„ ì‹œì‘
    requestAnimationFrame(t => this.loop(t));
  }

  resize(){
    const aspect = CFG.W / CFG.H;
    let w = window.innerWidth, h = window.innerHeight;
    if(w/h > aspect){
      h = Math.min(h, window.innerHeight * 0.96);
      w = h * aspect;
    } else {
      w = Math.min(w, window.innerWidth * 0.96);
      h = w / aspect;
    }
    this.canvas.style.width  = w+'px';
    this.canvas.style.height = h+'px';
  }

  reset(){
    this.player = new Player(this);
    if(this.imgLoaded) this.player.initSprite(this.dalsuImg);
    this.obstacles = [];
    this.items = [];
    this.floatTexts = [];
    this.score = 0;
    this.speed = CFG.BASE_SPD;
    this.stage = 0;
    this.growthPts = 0;
    this.combo = 0;
    this.lastComboTime = 0;
    this.comboTimeBonus = 0;
    this.stress = 0;
    this.burnout = false;
    this.burnoutTimer = 0;
    this.burnoutUsed = false;
    this.dayTime = 0.05;
    this.isOvertime = false;
    this.weather = null;
    this.weatherTimer = CFG.WEATHER_INTERVAL;
    this.focusMode = 0;
    this.scoreMult = 1;
    this.scoreMultTimer = 0;
    this.diffBonus = 0;
    this.obsTimer = 0;
    this.nextObsDelay = rand(CFG.OBS_MIN, CFG.OBS_MAX);
    this.currentEvent = null;
    this.lastEventScore = 0;
    this.cameraShake = 0;
    this.cameraZoom = 1;
    this.targetZoom = 1;
    this.timeScale = 1;
  }

  startGame(){
    this.snd.ensure();
    this.reset();
    this.state = ST.PLAY;
  }

  restart(){
    this.snd.ensure();
    this.reset();
    this.state = ST.PLAY;
  }

  pause(){  this.state = ST.PAUSE; }
  unpause(){ this.state = ST.PLAY; }

  addComboText(text, color){
    this.floatTexts.push(new FloatText(
      text,
      this.player.x + rand(-30,30),
      this.player.y - this.player.h - 20,
      color || '#ffeb3b'
    ));
  }

  triggerEvent(){
    this.currentEvent = pick(EVENTS);
    this.eventTimer = CFG.EVT_CHOICE_TIME;
    this.state = ST.EVENT;
  }

  chooseEvent(idx){
    if(!this.currentEvent) return;
    const choice = idx===0 ? this.currentEvent.a : this.currentEvent.b;
    choice.fn(this);
    this.addComboText(choice.text.split('(')[0].trim(), '#4fc3f7');
    this.currentEvent = null;
    this.state = ST.PLAY;
    this.lastEventScore = this.score;
  }

  levelUp(){
    if(this.stage >= CFG.STAGES.length-1) return;
    this.stage++;

    this.timeScale = 0.25;
    setTimeout(()=>{ this.timeScale=1; }, 280);

    this.targetZoom = Math.max(0.72, 1 - this.stage*0.04);

    this.particles.burst(this.player.x, this.player.y-this.player.h/2, 'grow', 25);
    this.cameraShake = 12;
    this.snd.grow();

    this.addComboText(`â˜… ${CFG.STAGES[this.stage].name} â˜…`, '#ffd700');

    if(this.stage === CFG.STAGES.length-1){
      this.player.giantMode = true;
      this.player.giantTimer = CFG.GIANT_DUR;
      this.snd.giant();
      this.addComboText('ê±°ëŒ€ ë‹¬ìˆ˜ ê°ì„±!!', '#ff5722');
    }
  }

  hitObstacle(obs){
    if(this.player.invincible > 0) return;

    // íŒŒê´´ ê°€ëŠ¥ ì¥ì• ë¬¼ + íŒŒê´´ ì¡°ê±´ ì¶©ì¡±
    if(obs.canBreak()){
      obs.alive = false;
      this.score += 50 * (this.player.giantMode ? CFG.GIANT_SCORE : 1);
      this.particles.burst(obs.x+obs.w/2, obs.y-obs.h/2, 'break', 15);
      this.cameraShake = 8;
      this.snd.brk();
      this.addComboText('ğŸ’¥ ë²½ íŒŒê´´!', '#ff9800');
      return;
    }

    // ìŠ¤íŠ¸ë ˆìŠ¤ ì¦ê°€
    this.stress = Math.min(100, this.stress + obs.td.stressAdd + CFG.STR_HIT);
    this.combo = 0;
    this.cameraShake = 10;
    this.snd.hit();
    this.particles.burst(this.player.x, this.player.y-this.player.h/2, 'spark', 8);

    // ë²ˆì•„ì›ƒ ì²´í¬
    if(this.stress >= 100){
      if(!this.burnoutUsed){
        this.burnout = true;
        this.burnoutTimer = CFG.BURNOUT_DUR;
        this.burnoutUsed = true;
        this.addComboText('âš  ë²ˆì•„ì›ƒ ì„ë°•!', '#ff1744');
      } else {
        this.gameOver();
        return;
      }
    }

    this.player.invincible = 1500;
    this.player.vy = CFG.JUMP * 0.4;
  }

  gameOver(){
    this.state = ST.OVER;
    this.timeScale = 0.2;
    setTimeout(()=>{ this.timeScale=1; }, 600);

    if(this.score > this.best){
      this.best = this.score;
      localStorage.setItem('dalsuBest', this.best.toString());
    }
    this.snd.hit();
  }

  // â”€â”€â”€ ì—…ë°ì´íŠ¸ â”€â”€â”€
  update(dt){
    if(this.state !== ST.PLAY) return;

    const ts = this.timeScale * (this.burnout ? 0.6 : 1);
    const d = dt * ts;

    // ì†ë„
    const overtimeMult = this.isOvertime ? CFG.OVERTIME_SPD : 1;
    this.speed = Math.min(CFG.MAX_SPD,
      (CFG.BASE_SPD + this.score * CFG.SPD_ACC + this.diffBonus) * overtimeMult
    );

    // í”Œë ˆì´ì–´
    this.player.update(d);

    // ë°°ê²½
    this.bg.update(this.speed, d);

    // í•˜ë£¨ ì‹œê°„
    this.dayTime += this.daySpeed * d / 60;
    if(this.dayTime >= 1) this.dayTime -= 1;
    this.isOvertime = this.dayTime > CFG.OVERTIME_TIME || this.dayTime < 0.05;

    // ë‚ ì”¨
    this.weatherTimer -= d*16.67;
    if(this.weatherTimer <= 0){
      if(!this.weather){
        this.weather = {
          type: pick(['rain','snow','dust']),
          intensity: rand(0.3,1),
          timer: CFG.WEATHER_DUR
        };
      }
      this.weatherTimer = CFG.WEATHER_INTERVAL;
    }
    if(this.weather){
      this.weather.timer -= d*16.67;
      if(this.weather.timer <= 0) this.weather = null;
      else {
        // ë‚ ì”¨ íŒŒí‹°í´
        if(this.weather.type==='rain'){
          for(let i=0;i<3;i++) this.particles.spawn(rand(0,CFG.W), -10, 'rain');
        } else if(this.weather.type==='snow'){
          if(Math.random()<0.3) this.particles.spawn(rand(0,CFG.W), -10, 'snow');
        }
      }
    }

    // ì¥ì• ë¬¼ ìŠ¤í°
    this.obsTimer += d*16.67;
    const spawnMult = this.isOvertime ? CFG.OVERTIME_SPAWN : 1;
    if(this.obsTimer >= this.nextObsDelay * spawnMult){
      this.spawnObstacle();
      this.obsTimer = 0;
      this.nextObsDelay = rand(CFG.OBS_MIN, CFG.OBS_MAX);
    }

    // ì¥ì• ë¬¼ ì—…ë°ì´íŠ¸/ì¶©ëŒ
    for(let i=this.obstacles.length-1; i>=0; i--){
      const obs = this.obstacles[i];
      obs.update(d);
      if(!obs.alive){ this.obstacles.splice(i,1); continue; }

      // í†µê³¼ ì²´í¬
      if(!obs.passed && obs.x + obs.w < this.player.x - this.player.w/2){
        obs.passed = true;
        const scoreMult = (this.isOvertime ? CFG.OVERTIME_SCORE : 1) * this.scoreMult;
        this.score += Math.round(10 * scoreMult);
        this.combo++;
        this.lastComboTime = performance.now();

        const growth = CFG.GROW_PER_CLEAR + (this.combo>1 ? CFG.GROW_COMBO : 0);
        this.growthPts += growth;
        this.stress = Math.max(0, this.stress - CFG.STR_COMBO * this.combo);

        if(this.combo > 2){
          this.addComboText(
            `x${this.combo} ${pick(this.comboTexts)}`,
            this.combo > 5 ? '#ff9800' : '#ffeb3b'
          );
        }

        this.particles.burst(obs.x+obs.w/2, obs.y-obs.h/2, 'score', 5);

        // ì„±ì¥ ì²´í¬
        const next = CFG.STAGES[this.stage+1];
        if(next && this.growthPts >= next.thr){
          this.levelUp();
        }
      }

      // ì¶©ëŒ
      if(!obs.passed && this.checkCollision(obs)){
        this.hitObstacle(obs);
        obs.passed = true;
      }
    }

    // ì½¤ë³´ íƒ€ì„ì•„ì›ƒ
    if(this.combo > 0 && performance.now() - this.lastComboTime > CFG.COMBO_TIMEOUT + this.comboTimeBonus){
      this.combo = 0;
      this.comboTimeBonus = 0;
    }

    // ì•„ì´í…œ
    for(let i=this.items.length-1; i>=0; i--){
      this.items[i].update(d);
      if(!this.items[i].alive){ this.items.splice(i,1); continue; }
      const it = this.items[i];
      const dx = it.x - this.player.x;
      const dy = it.y - (this.player.y - this.player.h/2);
      if(Math.abs(dx) < this.player.w/2+it.sz && Math.abs(dy) < this.player.h/2+it.sz){
        it.collect();
        this.items.splice(i,1);
      }
    }

    // ìŠ¤íŠ¸ë ˆìŠ¤ (ì•¼ê·¼ ì‹œ ì„œì„œíˆ ì¦ê°€)
    if(this.isOvertime){
      this.stress = Math.min(100, this.stress + CFG.STR_OVERTIME * d / 60);
    }

    // ë²ˆì•„ì›ƒ ìƒíƒœ
    if(this.burnout){
      this.burnoutTimer -= d*16.67;
      if(this.burnoutTimer <= 0){
        this.burnout = false;
        this.stress = 60;
        this.addComboText('ë²ˆì•„ì›ƒ íšŒë³µ! ğŸ’ª', '#4caf50');
      }
    }

    // ì§‘ì¤‘ ëª¨ë“œ íƒ€ì´ë¨¸
    if(this.focusMode > 0) this.focusMode -= d*16.67;
    if(this.scoreMultTimer > 0){
      this.scoreMultTimer -= d*16.67;
      if(this.scoreMultTimer <= 0) this.scoreMult = 1;
    }

    // ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
    if(this.score - this.lastEventScore >= CFG.EVT_SCORE_INTERVAL && this.state===ST.PLAY){
      if(Math.random() < 0.5) this.triggerEvent();
      this.lastEventScore = this.score;
    }

    // ì ìˆ˜ (ê±°ë¦¬ ê¸°ë°˜)
    this.score += Math.round(this.speed * 0.05 * d * this.scoreMult);

    // íŒŒí‹°í´
    this.particles.update(d);

    // í”Œë¡œíŠ¸ í…ìŠ¤íŠ¸
    for(let i=this.floatTexts.length-1; i>=0; i--){
      this.floatTexts[i].update(d);
      if(this.floatTexts[i].life<=0) this.floatTexts.splice(i,1);
    }

    // ì¹´ë©”ë¼
    if(this.cameraShake > 0){
      this.cameraShake *= 0.88;
      if(this.cameraShake < 0.3) this.cameraShake = 0;
    }
    this.cameraZoom = lerp(this.cameraZoom, this.targetZoom, 0.02*d);

    // ì‹¬ë°• íš¨ê³¼ (ìŠ¤íŠ¸ë ˆìŠ¤ ë†’ì„ ë•Œ)
    if(this.stress > 75 && Math.random()<0.005*d){
      this.snd.heartbeat();
    }
  }

  spawnObstacle(){
    let type = pick(OBS_TYPES);

    // ë©”ì¼ í­íƒ„ = ì—°ì† 3ê°œ
    if(type.multi){
      for(let i=0;i<3;i++){
        this.obstacles.push(new Obstacle(this, CFG.W + 60 + i*90, type));
      }
    } else {
      this.obstacles.push(new Obstacle(this, CFG.W + 60, type));
    }

    // ì•„ì´í…œ ìŠ¤í° í™•ë¥ 
    if(Math.random() < CFG.ITEM_CHANCE){
      this.items.push(new Item(this, CFG.W + 250 + Math.random()*200));
    }
  }

  checkCollision(obs){
    const p = this.player;
    const pad = 10 + p.scale * 3;

    const pl = p.x - p.w/2 + pad;
    const pr = p.x + p.w/2 - pad;
    const pt = p.y + p.bobY - p.h + pad;
    const pb = p.y + p.bobY - pad;

    let ol, or_, ot, ob;
    if(obs.td.tracking){
      ol = obs.x - obs.w/2;
      or_ = obs.x + obs.w/2;
      ot = obs.y - obs.h/2;
      ob = obs.y + obs.h/2;
    } else {
      ol = obs.x + 5;
      or_ = obs.x + obs.w - 5;
      ot = obs.y - obs.h + 5;
      ob = obs.y - 3;
    }

    return pr > ol && pl < or_ && pb > ot && pt < ob;
  }

  // â”€â”€â”€ ë Œë”ë§ â”€â”€â”€
  render(){
    const ctx = this.ctx;
    ctx.save();

    // ì¹´ë©”ë¼ í”ë“¤ë¦¼ + ì¤Œ
    let sx=0, sy=0;
    if(this.cameraShake > 0){
      sx = (Math.random()-0.5)*this.cameraShake*2;
      sy = (Math.random()-0.5)*this.cameraShake*2;
    }
    ctx.translate(CFG.W/2 + sx, CFG.H/2 + sy);
    ctx.scale(this.cameraZoom, this.cameraZoom);
    ctx.translate(-CFG.W/2, -CFG.H/2);

    // ë°°ê²½
    this.bg.render(ctx, this.dayTime, this.weather);

    if(this.state===ST.PLAY || this.state===ST.PAUSE || this.state===ST.EVENT || this.state===ST.OVER){
      // ì•„ì´í…œ
      for(const it of this.items) it.render(ctx);

      // ì¥ì• ë¬¼
      for(const obs of this.obstacles) obs.render(ctx);

      // í”Œë ˆì´ì–´
      this.player.render(ctx);

      // íŒŒí‹°í´ (í”Œë ˆì´ì–´ ìœ„)
      this.particles.render(ctx);

      // í”Œë¡œíŠ¸ í…ìŠ¤íŠ¸
      for(const ft of this.floatTexts) ft.render(ctx);
    }

    ctx.restore();

    // ìŠ¤íŠ¸ë ˆìŠ¤ ë¹„ë„¤íŒ…
    if(this.stress > 50 && (this.state===ST.PLAY||this.state===ST.OVER)){
      this.renderVignette(ctx);
    }

    // ë²ˆì•„ì›ƒ ì˜¤ë²„ë ˆì´
    if(this.burnout){
      ctx.fillStyle = `rgba(50,0,0,${0.15+Math.sin(performance.now()/300)*0.05})`;
      ctx.fillRect(0,0,CFG.W,CFG.H);
    }

    // HUD
    if(this.state===ST.PLAY || this.state===ST.PAUSE || this.state===ST.EVENT){
      this.renderHUD(ctx);
    }

    // ì´ë¯¸ì§€ ë¯¸ë¡œë“œ ì•ˆë‚´
    if(this.imgFailed && !this.imgLoaded){
      this.renderImageOverlay(ctx);
    }

    // í™”ë©´ ìƒíƒœë³„ ì˜¤ë²„ë ˆì´
    switch(this.state){
      case ST.LOADING: this.renderLoading(ctx); break;
      case ST.TITLE:   this.renderTitle(ctx);   break;
      case ST.PAUSE:   this.renderPause(ctx);   break;
      case ST.EVENT:   this.renderEvent(ctx);   break;
      case ST.OVER:    this.renderOver(ctx);    break;
    }
  }

  renderVignette(ctx){
    const intensity = (this.stress - 50) / 50;
    const pulse = Math.sin(performance.now()/400)*0.3+0.7;
    const alpha = intensity * pulse * 0.4;
    const grd = ctx.createRadialGradient(CFG.W/2, CFG.H/2, CFG.W*0.25, CFG.W/2, CFG.H/2, CFG.W*0.7);
    grd.addColorStop(0, 'rgba(100,0,0,0)');
    grd.addColorStop(1, `rgba(100,0,0,${alpha})`);
    ctx.fillStyle = grd;
    ctx.fillRect(0,0,CFG.W,CFG.H);
  }

  renderHUD(ctx){
    ctx.save();

    // íŒ¨ë„ ë°°ê²½
    ctx.fillStyle = 'rgba(0,0,0,0.55)';
    const panelW = 310, panelH = 155;
    ctx.beginPath();
    ctx.roundRect(12, 8, panelW, panelH, 8);
    ctx.fill();

    ctx.fillStyle = '#fff';
    ctx.font = 'bold 20px Malgun Gothic';
    ctx.textAlign = 'left';
    ctx.fillText(`ì ìˆ˜: ${this.score}`, 24, 34);

    ctx.fillStyle = '#aaa';
    ctx.font = '14px Malgun Gothic';
    ctx.fillText(`BEST: ${this.best}`, 180, 34);

    // ë‹¨ê³„
    ctx.fillStyle = '#4fc3f7';
    ctx.font = 'bold 16px Malgun Gothic';
    ctx.fillText(`${CFG.STAGES[this.stage].name}`, 24, 58);

    // ì„±ì¥ ê²Œì´ì§€
    const next = CFG.STAGES[this.stage+1];
    const barX=24, barY=66, barW=280, barH=10;
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.fillRect(barX, barY, barW, barH);
    if(next){
      const cur = CFG.STAGES[this.stage].thr;
      const prog = clamp((this.growthPts-cur)/(next.thr-cur), 0, 1);
      const grd = ctx.createLinearGradient(barX,0,barX+barW,0);
      grd.addColorStop(0,'#4caf50');
      grd.addColorStop(1,'#8bc34a');
      ctx.fillStyle = grd;
      ctx.fillRect(barX, barY, barW*prog, barH);
    } else {
      ctx.fillStyle = '#ffd700';
      ctx.fillRect(barX, barY, barW, barH);
    }

    // ìŠ¤íŠ¸ë ˆìŠ¤ ê²Œì´ì§€
    ctx.fillStyle = '#bbb';
    ctx.font = '13px Malgun Gothic';
    ctx.fillText('ìŠ¤íŠ¸ë ˆìŠ¤', 24, 96);
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.fillRect(barX+70, 86, barW-70, barH);
    const stColor = this.stress>75?'#f44336':this.stress>40?'#ff9800':'#66bb6a';
    ctx.fillStyle = stColor;
    ctx.fillRect(barX+70, 86, (barW-70)*(this.stress/100), barH);

    // ì½¤ë³´
    if(this.combo > 1){
      ctx.fillStyle = '#ffeb3b';
      ctx.font = 'bold 18px Malgun Gothic';
      ctx.fillText(`ì½¤ë³´ x${this.combo}`, 24, 120);
    }

    // ì‹œê°„ëŒ€
    const timeLabels = ['ì•„ì¹¨','ì˜¤ì „','ë‚®','ì˜¤í›„','ì €ë…','ë°¤','ì•¼ê·¼','ìƒˆë²½'];
    const tIdx = Math.floor(this.dayTime * timeLabels.length) % timeLabels.length;
    ctx.fillStyle = this.isOvertime ? '#ff5252' : '#90caf9';
    ctx.font = 'bold 14px Malgun Gothic';
    ctx.fillText(timeLabels[tIdx], 200, 120);

    if(this.isOvertime){
      ctx.fillStyle = '#ff5252';
      ctx.font = 'bold 12px Malgun Gothic';
      ctx.fillText('Ã— ì•¼ê·¼ ëª¨ë“œ Ã—', 200, 140);
    }

    // ì§‘ì¤‘ ëª¨ë“œ
    if(this.focusMode > 0){
      ctx.fillStyle = '#00e5ff';
      ctx.font = 'bold 14px Malgun Gothic';
      ctx.fillText(`â˜• ì§‘ì¤‘ ${(this.focusMode/1000).toFixed(1)}s`, 24, 150);
    }
    // ì ìˆ˜ ë°°ìœ¨
    if(this.scoreMult > 1){
      ctx.fillStyle = '#ffc107';
      ctx.font = 'bold 14px Malgun Gothic';
      ctx.fillText(`ğŸ’° x${this.scoreMult} ${(this.scoreMultTimer/1000).toFixed(1)}s`, 140, 150);
    }

    // ì‚¬ìš´ë“œ í† ê¸€ í‘œì‹œ
    ctx.fillStyle = '#666';
    ctx.font = '12px Malgun Gothic';
    ctx.textAlign = 'right';
    ctx.fillText(`ğŸ”Š ${this.snd.on?'ON':'OFF'} (M)`, CFG.W-16, 24);

    ctx.restore();
  }

  renderImageOverlay(ctx){
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    const ow=420, oh=60;
    ctx.fillRect(CFG.W/2-ow/2, CFG.H-oh-20, ow, oh);
    ctx.fillStyle = '#ff9800';
    ctx.font = 'bold 18px Malgun Gothic';
    ctx.textAlign = 'center';
    ctx.fillText('âš  dalsu.pngë¥¼ í”„ë¡œì íŠ¸ í´ë”ì— ë„£ì–´ì£¼ì„¸ìš”!', CFG.W/2, CFG.H-40);
    ctx.restore();
  }

  renderLoading(ctx){
    ctx.fillStyle = '#0a0a1a';
    ctx.fillRect(0,0,CFG.W,CFG.H);
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 28px Malgun Gothic';
    ctx.textAlign = 'center';
    const dots = '.'.repeat(Math.floor(performance.now()/400)%4);
    ctx.fillText('ë¡œë”© ì¤‘'+dots, CFG.W/2, CFG.H/2);
  }

  renderTitle(ctx){
    // ë°°ê²½ì„ ê·¸ë¦° í›„ ì˜¤ë²„ë ˆì´
    ctx.fillStyle = 'rgba(0,0,0,0.65)';
    ctx.fillRect(0,0,CFG.W,CFG.H);

    ctx.textAlign = 'center';

    // íƒ€ì´í‹€
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 60px Malgun Gothic';
    ctx.fillText('ë‹¬ìˆ˜ í‚¤ìš°ê¸°', CFG.W/2, 180);

    ctx.fillStyle = '#4fc3f7';
    ctx.font = 'bold 36px Malgun Gothic';
    ctx.fillText('íŒêµ ì§ì¥ì¸ ìƒì¡´ê¸°', CFG.W/2, 235);

    // ë‹¬ìˆ˜ ë¯¸ë¦¬ë³´ê¸°
    if(this.imgLoaded){
      const pw = 100, ph = pw * (this.dalsuImg.height/this.dalsuImg.width);
      ctx.drawImage(this.dalsuImg, CFG.W/2-pw/2, 260, pw, ph);
    }

    ctx.fillStyle = '#e0e0e0';
    ctx.font = '20px Malgun Gothic';
    ctx.fillText('íŒêµì—ì„œ ì‚´ì•„ë‚¨ì•„ë¼!', CFG.W/2, 420);

    ctx.font = '17px Malgun Gothic';
    ctx.fillStyle = '#bbb';
    ctx.fillText('ìŠ¤í˜ì´ìŠ¤ / í´ë¦­: ì í”„ (ê¸¸ê²Œ ëˆ„ë¥´ë©´ ë†’ì´)   P: ì¼ì‹œì •ì§€   M: ì‚¬ìš´ë“œ', CFG.W/2, 470);
    ctx.fillText('ì¥ì• ë¬¼ì„ í”¼í•´ ì„±ì¥í•˜ê³ , ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ ê´€ë¦¬í•˜ë¼!', CFG.W/2, 500);

    // ì‹œì‘ ì•ˆë‚´
    const pulse = Math.sin(performance.now()/250)*0.3+0.7;
    ctx.globalAlpha = pulse;
    ctx.fillStyle = '#ffeb3b';
    ctx.font = 'bold 30px Malgun Gothic';
    ctx.fillText('ìŠ¤í˜ì´ìŠ¤ ë˜ëŠ” í´ë¦­ìœ¼ë¡œ ì‹œì‘', CFG.W/2, 580);
    ctx.globalAlpha = 1;

    if(this.best > 0){
      ctx.fillStyle = '#777';
      ctx.font = '16px Malgun Gothic';
      ctx.fillText(`ìµœê³  ê¸°ë¡: ${this.best}`, CFG.W/2, 640);
    }

    ctx.textAlign = 'left';
  }

  renderPause(ctx){
    ctx.fillStyle = 'rgba(0,0,0,0.55)';
    ctx.fillRect(0,0,CFG.W,CFG.H);
    ctx.textAlign = 'center';
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 54px Malgun Gothic';
    ctx.fillText('ì¼ì‹œì •ì§€', CFG.W/2, CFG.H/2 - 10);
    ctx.font = '22px Malgun Gothic';
    ctx.fillStyle = '#ccc';
    ctx.fillText('P ë˜ëŠ” ìŠ¤í˜ì´ìŠ¤ë¡œ ê³„ì†', CFG.W/2, CFG.H/2+40);
    ctx.textAlign = 'left';
  }

  renderEvent(ctx){
    // ì´ë²¤íŠ¸ ì„ íƒ UI
    this.eventTimer -= 16.67;
    if(this.eventTimer <= 0){
      this.chooseEvent(Math.random()<0.5?0:1);
      return;
    }

    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,CFG.W,CFG.H);

    const ev = this.currentEvent;
    if(!ev) return;

    ctx.textAlign = 'center';
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 32px Malgun Gothic';
    ctx.fillText(ev.title, CFG.W/2, CFG.H/2 - 70);

    // íƒ€ì´ë¨¸ ë°”
    const prog = this.eventTimer / CFG.EVT_CHOICE_TIME;
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.fillRect(CFG.W/2-200, CFG.H/2-45, 400, 8);
    ctx.fillStyle = prog>0.3?'#4fc3f7':'#f44336';
    ctx.fillRect(CFG.W/2-200, CFG.H/2-45, 400*prog, 8);

    // ì„ íƒì§€ ë²„íŠ¼
    const bw = 280, bh = 55;
    const bx1 = CFG.W/2 - bw - 15, bx2 = CFG.W/2 + 15;
    const by = CFG.H/2;

    ctx.fillStyle = 'rgba(33,150,243,0.8)';
    ctx.beginPath(); ctx.roundRect(bx1, by, bw, bh, 8); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 16px Malgun Gothic';
    ctx.fillText('[1] '+ev.a.text, bx1+bw/2, by+33);

    ctx.fillStyle = 'rgba(255,87,34,0.8)';
    ctx.beginPath(); ctx.roundRect(bx2, by, bw, bh, 8); ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.fillText('[2] '+ev.b.text, bx2+bw/2, by+33);

    ctx.textAlign = 'left';
  }

  renderOver(ctx){
    ctx.fillStyle = 'rgba(0,0,0,0.8)';
    ctx.fillRect(0,0,CFG.W,CFG.H);

    ctx.textAlign = 'center';
    ctx.fillStyle = '#f44336';
    ctx.font = 'bold 64px Malgun Gothic';
    ctx.fillText('ë²ˆì•„ì›ƒ ë°œìƒ', CFG.W/2, 220);

    ctx.fillStyle = '#fff';
    ctx.font = '32px Malgun Gothic';
    ctx.fillText(`ìµœì¢… ì ìˆ˜: ${this.score}`, CFG.W/2, 310);

    ctx.font = '26px Malgun Gothic';
    ctx.fillStyle = '#4fc3f7';
    ctx.fillText(`ë„ë‹¬ ë‹¨ê³„: ${CFG.STAGES[this.stage].name}`, CFG.W/2, 360);

    if(this.score >= this.best && this.score > 0){
      ctx.fillStyle = '#ffd700';
      ctx.font = 'bold 28px Malgun Gothic';
      ctx.fillText('â˜… ì‹ ê¸°ë¡! â˜…', CFG.W/2, 420);
    }

    ctx.fillStyle = '#999';
    ctx.font = '18px Malgun Gothic';
    ctx.fillText(`ìµœê³  ê¸°ë¡: ${this.best}`, CFG.W/2, 470);

    const pulse = Math.sin(performance.now()/300)*0.3+0.7;
    ctx.globalAlpha = pulse;
    ctx.fillStyle = '#4caf50';
    ctx.font = 'bold 28px Malgun Gothic';
    ctx.fillText('ìŠ¤í˜ì´ìŠ¤ / í´ë¦­ / Rë¡œ ì¬ì‹œì‘', CFG.W/2, 550);
    ctx.globalAlpha = 1;

    ctx.textAlign = 'left';
  }

  // â”€â”€â”€ ë©”ì¸ ë£¨í”„ â”€â”€â”€
  loop(now){
    const raw = now - (this.lastTime || now);
    this.lastTime = now;
    const dt = Math.min(raw, 50) / 16.67;

    this.update(dt);
    this.render();

    requestAnimationFrame(t => this.loop(t));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  roundRect í´ë¦¬í•„
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    if(typeof r==='number') r={tl:r,tr:r,br:r,bl:r};
    this.moveTo(x+r.tl,y);
    this.lineTo(x+w-r.tr,y);
    this.quadraticCurveTo(x+w,y,x+w,y+r.tr);
    this.lineTo(x+w,y+h-r.br);
    this.quadraticCurveTo(x+w,y+h,x+w-r.br,y+h);
    this.lineTo(x+r.bl,y+h);
    this.quadraticCurveTo(x,y+h,x,y+h-r.bl);
    this.lineTo(x,y+r.tl);
    this.quadraticCurveTo(x,y,x+r.tl,y);
    this.closePath();
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ê²Œì„ ì‹œì‘!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const game = new Game();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ ìƒìˆ˜ ìš”ì•½ (CFG ê°ì²´ ë‚´):
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   W, H            : ìº”ë²„ìŠ¤ í•´ìƒë„ (1280Ã—720)
   GROUND          : ë°”ë‹¥ Y ì¢Œí‘œ (580)
   GRAVITY         : ì¤‘ë ¥ ê°€ì†ë„ (0.72)
   JUMP            : ì í”„ ì´ˆê¸° ì†ë„ (-15.2)
   JUMP_HOLD       : ì í”„ í™€ë“œ ì¶”ê°€ ê°ì† (-0.55)
   COYOTE          : ì½”ìš”í…Œ íƒ€ì„ (100ms)
   JUMP_BUF        : ì í”„ ë²„í¼ (100ms)
   BASE_SPD        : ê¸°ë³¸ ê²Œì„ ì†ë„ (5.5)
   MAX_SPD         : ìµœëŒ€ ì†ë„ (15)
   SPD_ACC         : ì ìˆ˜ë‹¹ ì†ë„ ì¦ê°€ (0.003)
   GROW_PER_CLEAR  : ì¥ì• ë¬¼ í†µê³¼ ì‹œ ì„±ì¥ëŸ‰ (18)
   GROW_COMBO      : ì½¤ë³´ ì¶”ê°€ ì„±ì¥ëŸ‰ (8)
   COMBO_TIMEOUT   : ì½¤ë³´ ìœ ì§€ ì‹œê°„ (2500ms)
   STR_HIT         : ì¶©ëŒ ì‹œ ìŠ¤íŠ¸ë ˆìŠ¤ (22)
   STR_OVERTIME    : ì•¼ê·¼ ìŠ¤íŠ¸ë ˆìŠ¤ ì¦ê°€ìœ¨ (0.35/ì´ˆ)
   STR_COFFEE      : ì»¤í”¼ ìŠ¤íŠ¸ë ˆìŠ¤ ê°ì†Œ (-35)
   BURNOUT_DUR     : ë²ˆì•„ì›ƒ ë””ë²„í”„ ì‹œê°„ (5000ms)
   OBS_MIN/MAX     : ì¥ì• ë¬¼ ìŠ¤í° ê°„ê²© (1300~2600ms)
   ITEM_CHANCE     : ì•„ì´í…œ ìŠ¤í° í™•ë¥  (0.18)
   EVT_SCORE_INTERVAL : ì´ë²¤íŠ¸ ë°œìƒ ì ìˆ˜ ê°„ê²© (280)
   OVERTIME_TIME   : ì•¼ê·¼ ì‹œì‘ ì‹œê°„ëŒ€ (0.75)
   OVERTIME_SPD    : ì•¼ê·¼ ì†ë„ ë°°ìœ¨ (1.25)
   OVERTIME_SCORE  : ì•¼ê·¼ ì ìˆ˜ ë°°ìœ¨ (1.8)
   GIANT_DUR       : ê±°ëŒ€ ë‹¬ìˆ˜ ì§€ì† ì‹œê°„ (10000ms)
   DAY_LENGTH      : ê²Œì„ ë‚´ í•˜ë£¨ ê¸¸ì´ (120ì´ˆ)
   STAGES          : ì„±ì¥ ë‹¨ê³„ ë°°ì—´ (7ë‹¨ê³„)
   P_W, P_H        : í”Œë ˆì´ì–´ ê¸°ë³¸ í¬ê¸° (72Ã—96)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
</script>
</body>
</html>
